/*
 * shmmixer.cpp
 *
 *  Created on: Oct 6, 2024
 *      Author: sirius
 */

#include <rtsp/ShmMixer.h>


void ShmMixer_class::InitShm()
{
	for( uint shmid = 0; shmid < MAXCONFIG ; shmid ++ )
	{
		DaTA_p->SHM_vecL[shmid].Clear();
		DaTA_p->SHM_vecR[shmid].Clear();
	}

}

void operator+=( stereo_t& lhs, stereo_t& rhs)
{
	lhs.left += rhs.left;
	lhs.right+= rhs.right;
};

void ShmMixer_class::AddShm()
{
	error = -1;
	if( DaTA_p->SDS_Id != 0 ) return; // not yor job

	stereo_t* audio_data = DaTA_p->GetShm_addr( 0 );
	error = -2;
	if ( not audio_data ) return;

	assert( max_frames == DaTA_p->SHM_vecL[0].ds.size / sizeof_stereo );

	for( uint shmid = 1; shmid < MAXCONFIG ; shmid ++ )
	{
		stereo_t* shm_addr = DaTA_p->GetShm_addr( shmid );
		error = shmid;
		if ( not shm_addr ) return;

		for( buffer_t n = 0; n < max_frames; n++ )
		{
			audio_data[n] += shm_addr[n];
		}
	}
	error = 0;
}

